# --- SCRIPTS ---
script:
  - id: start_wake_word
    then:
      - logger.log: "ğŸ” start_wake_word called - waiting for idle..."
      - wait_until:
          condition:
            not: voice_assistant.is_running
      - logger.log: "ğŸ” start_wake_word - voice assistant is idle, starting mic..."
      - micro_wake_word.start:
  - id: stop_wake_word
    then:
      - logger.log: "ğŸ”‡ Stoppe Wake Word"
      - micro_wake_word.stop:

# --- WAKE WORD ---
micro_wake_word:
  id: mww
  microphone: cosmo_mic
  models:
    - model: okay_nabu
      probability_cutoff: 0.85
  on_wake_word_detected:
    - logger.log: "ğŸ™ï¸ WAKE WORD erkannt!"
    - voice_assistant.start:
        wake_word: !lambda return wake_word;

# --- VOICE ASSISTANT (Home Assistant) ---
voice_assistant:
  id: va
  microphone: cosmo_mic
  speaker: cosmo_speaker
  micro_wake_word: mww
  noise_suppression_level: 2
  auto_gain: 31dBFS
  volume_multiplier: 0.6
  on_start:
    - logger.log: "ğŸš€ Voice Pipeline gestartet"
  on_listening:
    - logger.log: "ğŸ¤ HÃ¶re zu..."
    - globals.set:
        id: is_listening
        value: "true"
  on_stt_vad_start:
    - logger.log: "ğŸ—£ï¸ VAD erkannt - Sprachentdeckung gestartet"
  on_stt_vad_end:
    - logger.log: "ğŸ”‡ VAD Ende - Verarbeitung..."
    - globals.set:
        id: is_listening
        value: "false"
  on_stt_end:
    - logger.log:
        format: "ğŸ“ Erkannt: %s"
        args: ['x.c_str()']
    - text_sensor.template.publish:
        id: user_text
        state: !lambda 'return x;'
    - globals.set:
        id: is_listening
        value: "false"
  on_intent_start:
    - logger.log: "ğŸ¤” Intent Verarbeitung gestartet"
  on_intent_progress:
    - logger.log: "â³ Intent wird verarbeitet..."
  on_intent_end:
    - logger.log: "ğŸ’¡ Intent Verarbeitung beendet"
  on_tts_start:
    - logger.log:
        format: "ğŸ”Š Antwort: %s"
        args: ['x.c_str()']
    - text_sensor.template.publish:
        id: bot_text
        state: !lambda 'return x;'

  on_tts_end:
    - logger.log:
        format: "ğŸ TTS Generierung fertig (URL: %s)"
        args: ['x.c_str()']
  on_tts_stream_start:
    - logger.log: "ğŸ”ˆ TTS Audio Stream startet..."
    - globals.set:
        id: is_speaking
        value: "true"
  on_tts_stream_end:
    - logger.log: "ğŸ”ˆ TTS Audio Stream beendet"
    - globals.set:
        id: is_speaking
        value: "false"
    - delay: 200ms
    - logger.log: "ğŸ‘‚ Continuous Mode - Listening for follow-up..."
    - voice_assistant.start:
  on_idle:
    - logger.log: "ğŸ’¤ Voice Assistant IDLE - alles fertig"
    - script.execute: start_wake_word
    # Text zurÃ¼cksetzen
    - text_sensor.template.publish:
        id: user_text
        state: ""
    - text_sensor.template.publish:
        id: bot_text
        state: ""
  on_end:
    - logger.log: "âœ… Voice Assistant fertig"
    - globals.set:
        id: is_listening
        value: "false"
  on_error:
    - logger.log:
        format: "âŒ Fehler: %s - %s"
        args: ['code.c_str()', 'message.c_str()']
    - globals.set:
        id: is_speaking
        value: "false"
    - script.execute: start_wake_word
  on_client_connected:
    - logger.log: "âœ… Home Assistant verbunden"
    - globals.set:
        id: is_ready
        value: "true"
    # Starting wake word here ensures we are ready
    - script.execute: start_wake_word
  on_client_disconnected:
    - logger.log: "âŒ Home Assistant getrennt"
    - script.execute: stop_wake_word
    - globals.set:
        id: is_speaking
        value: "false"
    - globals.set:
        id: is_listening
        value: "false"
