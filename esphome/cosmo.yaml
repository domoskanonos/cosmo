# Cosmo Voice Assistant - ESPHome Konfiguration f√ºr Home Assistant
# Hardware: SP-ESP32-S3-1.28-BOX mit ES8311 Audio Codec
# Basierend auf offizieller ESP32-S3-Box-3 Konfiguration

substitutions:
  name: "cosmo-box-3"
  friendly_name: "Cosmo AI"

esphome:
  name: ${name}
  friendly_name: ${friendly_name}
  min_version: 2024.6.0
  name_add_mac_suffix: true
  on_boot:
    priority: -100
    then:
      - output.turn_on: backlight
      - script.execute: start_wake_word
      - logger.log: "üöÄ Boot: Display + Wake Word aktiv"

esp32:
  board: esp32-s3-devkitc-1
  variant: esp32s3
  framework:
    type: esp-idf

network:
  enable_high_performance: false

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  ap:
    ssid: "Cosmo Fallback Hotspot"

api:

logger:
  level: DEBUG

ota:
  - platform: esphome

web_server:
  port: 80

# --- AUDIO HARDWARE ---
i2c:
  sda: GPIO15
  scl: GPIO14
  scan: true

audio_dac:
  - platform: es8311
    id: es8311_codec
    bits_per_sample: 16bit
    sample_rate: 16000
    mic_gain: 42dB

i2s_audio:
  - id: i2s_bus
    i2s_lrclk_pin: GPIO45
    i2s_bclk_pin: GPIO9
    i2s_mclk_pin: GPIO16

microphone:
  - platform: i2s_audio
    id: cosmo_mic
    i2s_audio_id: i2s_bus
    adc_type: external
    pdm: false
    i2s_din_pin: GPIO10
    channel: left
    bits_per_sample: 16bit
    sample_rate: 16000

speaker:
  - platform: i2s_audio
    id: cosmo_speaker
    i2s_audio_id: i2s_bus
    dac_type: external
    i2s_dout_pin: GPIO8
    bits_per_sample: 16bit
    sample_rate: 16000
    channel: left
    audio_dac: es8311_codec
    buffer_duration: 100ms

# Media Player - handhabt I2S-Bus Switching korrekt
media_player:
  - platform: speaker
    name: "Cosmo Media Player"
    id: cosmo_media_player
    announcement_pipeline:
      speaker: cosmo_speaker
      format: WAV
      sample_rate: 16000
      num_channels: 1
    on_announcement:
      - logger.log: "üì¢ Announcement startet"
      # Stoppe Wake Word wenn Mikrofon aktiv ist
      - if:
          condition:
            - microphone.is_capturing:
          then:
            - script.execute: stop_wake_word
    on_idle:
      - logger.log: "üì¢ Media Player idle"
      # Starte Wake Word nur wenn VA nicht l√§uft
      - if:
          condition:
            not:
              voice_assistant.is_running:
          then:
            - script.execute: start_wake_word

# --- OUTPUTS ---
output:
  - platform: gpio
    pin:
      number: GPIO42
      inverted: true
    id: backlight

switch:
  - platform: gpio
    name: "Speaker Enable"
    id: pa_enable
    pin: GPIO46
    restore_mode: ALWAYS_ON

# --- DISPLAY ---
spi:
  id: spi_bus
  clk_pin: GPIO4
  mosi_pin: GPIO2

font:
  - file: "gfonts://Roboto"
    id: font_normal
    size: 20
  - file: "gfonts://Roboto"
    id: font_small
    size: 14

display:
  - platform: ili9xxx
    model: GC9A01A
    id: cosmo_display
    spi_id: spi_bus
    dimensions:
      height: 240
      width: 240
    cs_pin: GPIO5
    dc_pin: GPIO47
    reset_pin: GPIO38
    invert_colors: false
    update_interval: 1s
    lambda: |-
      it.fill(Color::BLACK);
      it.filled_circle(80, 90, 25, Color(0xFFFF00));
      it.filled_circle(160, 90, 25, Color(0xFFFF00));
      it.printf(120, 160, id(font_small), Color(0x888888), TextAlign::CENTER, "%s", id(user_text).state.c_str());
      it.printf(120, 190, id(font_normal), Color(0xFFFFFF), TextAlign::CENTER, "%s", id(bot_text).state.c_str());

text_sensor:
  - platform: template
    name: "User Text"
    id: user_text
    update_interval: never
  - platform: template
    name: "Bot Response"
    id: bot_text
    update_interval: never

# --- SCRIPTS f√ºr I2S-Bus Management ---
script:
  - id: start_wake_word
    then:
      - if:
          condition:
            - not:
                voice_assistant.is_running:
          then:
            - logger.log: "üéôÔ∏è Starte Wake Word Detection"
            - micro_wake_word.start:

  - id: stop_wake_word
    then:
      - logger.log: "üîá Stoppe Wake Word"
      - micro_wake_word.stop:

# --- WAKE WORD ---
micro_wake_word:
  id: mww
  microphone: cosmo_mic
  models:
    - model: okay_nabu
      probability_cutoff: 0.85
  on_wake_word_detected:
    - logger.log: "üéôÔ∏è WAKE WORD erkannt!"
    - voice_assistant.start:
        wake_word: !lambda return wake_word;

# --- VOICE ASSISTANT (Home Assistant) ---
voice_assistant:
  id: va
  microphone: cosmo_mic
  speaker: cosmo_speaker
  micro_wake_word: mww
  noise_suppression_level: 2
  auto_gain: 31dBFS
  volume_multiplier: 2.0
  on_listening:
    - logger.log: "üé§ H√∂re zu..."
  on_stt_vad_end:
    - logger.log: "üîá VAD Ende - Verarbeitung..."
  on_stt_end:
    - logger.log:
        format: "üìù Erkannt: %s"
        args: ['x.c_str()']
    - text_sensor.template.publish:
        id: user_text
        state: !lambda 'return x;'
  on_tts_stream_start:
    - logger.log: "üîà TTS Audio Stream startet..."
  on_tts_start:
    - logger.log:
        format: "üîä Antwort: %s"
        args: ['x.c_str()']
    - text_sensor.template.publish:
        id: bot_text
        state: !lambda 'return x;'
  on_tts_stream_start:
    - logger.log: "üîà TTS Audio Stream startet..."
  on_tts_stream_end:
    - logger.log: "üîà TTS Audio Stream beendet"
  on_idle:
    - logger.log: "üí§ Voice Assistant IDLE - alles fertig"
    - script.execute: start_wake_word
    # Text zur√ºcksetzen
    - text_sensor.template.publish:
        id: user_text
        state: ""
    - text_sensor.template.publish:
        id: bot_text
        state: ""
  on_end:
    - logger.log: "‚úÖ Voice Assistant fertig"
  on_error:
    - logger.log:
        format: "‚ùå Fehler: %s - %s"
        args: ['code.c_str()', 'message.c_str()']
    - script.execute: start_wake_word
  on_client_connected:
    - logger.log: "‚úÖ Home Assistant verbunden"
    - script.execute: start_wake_word
  on_client_disconnected:
    - logger.log: "‚ùå Home Assistant getrennt"
    - script.execute: stop_wake_word
